'use client'

import { useEffect, useState } from 'react'
export const dynamic = 'force-dynamic'
import { useSession } from 'next-auth/react'
import { PermissionGuard, CRUDGuard, usePermissions } from '@/components/PermissionGuard'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { 
  Shield, 
  Users, 
  Calendar, 
  Settings, 
  BarChart3, 
  CreditCard,
  MessageSquare,
  Palette,
  Eye,
  Plus,
  Edit,
  Trash2,
  CheckCircle,
  XCircle
} from 'lucide-react'
type TestResult = {
  resource: string
  operation: string
  allowed: boolean
  permission: string
}
export default function PermissionTestPage() {
  const { data: session } = useSession()
  const { userPermissions, hasPermission, canPerformCRUD, isLoading } = usePermissions()
  const [testResults, setTestResults] = useState<TestResult[]>([])
  const [apiTestResults, setApiTestResults] = useState<Record<string, any>>({})
  // Resources to test
  const resources = [
    { name: 'users', label: 'Users', icon: Users },
    { name: 'events', label: 'Events', icon: Calendar },
    { name: 'roles', label: 'Roles', icon: Shield },
    { name: 'analytics', label: 'Analytics', icon: BarChart3 },
    { name: 'payments', label: 'Payments', icon: CreditCard },
    { name: 'communication', label: 'Communication', icon: MessageSquare },
    { name: 'design', label: 'Design', icon: Palette },
    { name: 'system', label: 'System', icon: Settings }
  ]
  const operations = ['view', 'create', 'edit', 'delete']
  useEffect(() => {
    if (userPermissions) {
      // Test all CRUD operations for each resource
      const results: TestResult[] = []
      
      resources.forEach(resource => {
        operations.forEach(operation => {
          const permission = `${resource.name}.${operation}`
          const allowed = hasPermission(permission)
          
          results.push({
            resource: resource.name,
            operation,
            allowed,
            permission
          })
        })
      })
      setTestResults(results)
    }
  }, [userPermissions])
  // Test API endpoints with different permissions
  const testAPIEndpoint = async (endpoint: string, method: string = 'GET') => {
    try {
      const response = await fetch(endpoint, { method })
      const data = await response.json()
      setApiTestResults(prev => ({
        ...prev,
        [endpoint]: {
          status: response.status,
          success: response.ok,
          message: data.message || data.error || 'Success',
          data: response.ok ? data : null
        }
      }))
    } catch (error: any) {
          status: 500,
          success: false,
          message: error.message,
          data: null
  }
  const apiEndpoints = [
    { url: '/api/admin/users', label: 'Get Users', permission: 'users.view' },
    { url: '/api/admin/permissions', label: 'Get Roles & Permissions', permission: 'roles.view' },
    { url: '/api/events', label: 'Get Events', permission: 'events.view' },
    { url: '/api/admin/analytics', label: 'Get Analytics', permission: 'analytics.view' }
  if (isLoading) {
    return (
      <div className="p-6">
        <div className="animate-pulse space-y-4">
          <div className="h-8 bg-gray-200 rounded w-1/3"></div>
          <div className="h-64 bg-gray-200 rounded"></div>
        </div>
      </div>
    )
  return (
    <div className="p-6 space-y-6">
      {/* Header */}
      <div>
        <h1 className="text-2xl font-bold flex items-center gap-2">
          <Shield className="h-6 w-6" />
          Permission Testing Dashboard
        </h1>
        <p className="text-sm text-gray-600 mt-1">
          Test role-based access control and CRUD operations
        </p>
      {/* Current User Info */}
      <Card>
        <CardHeader>
          <CardTitle>Current User Information</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label className="text-sm font-medium text-gray-700">Name</label>
              <p className="text-sm text-gray-900">{session?.user?.name}</p>
            </div>
              <label className="text-sm font-medium text-gray-700">Email</label>
              <p className="text-sm text-gray-900">{session?.user?.email}</p>
              <label className="text-sm font-medium text-gray-700">Role</label>
              <p className="text-sm text-gray-900">{userPermissions?.role}</p>
          </div>
          <div className="mt-4">
            <label className="text-sm font-medium text-gray-700">Permissions ({userPermissions?.permissions.length || 0})</label>
            <div className="mt-2 flex flex-wrap gap-1">
              {userPermissions?.permissions.map(permission => (
                <span
                  key={permission}
                  className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800"
                >
                  {permission}
                </span>
              ))}
        </CardContent>
      </Card>
      {/* CRUD Operations Test */}
          <CardTitle>CRUD Operations Test</CardTitle>
          <p className="text-sm text-gray-600">
            Test Create, Read, Update, Delete permissions for each resource
          </p>
          <div className="overflow-x-auto">
            <table className="min-w-full text-sm">
              <thead>
                <tr className="border-b">
                  <th className="text-left py-2 px-3 font-medium">Resource</th>
                  <th className="text-center py-2 px-3 font-medium">View</th>
                  <th className="text-center py-2 px-3 font-medium">Create</th>
                  <th className="text-center py-2 px-3 font-medium">Edit</th>
                  <th className="text-center py-2 px-3 font-medium">Delete</th>
                </tr>
              </thead>
              <tbody>
                {resources.map(resource => {
                  const crud = canPerformCRUD(resource.name)
                  const ResourceIcon = resource.icon
                  
                  return (
                    <tr key={resource.name} className="border-b hover:bg-gray-50">
                      <td className="py-3 px-3">
                        <div className="flex items-center gap-2">
                          <ResourceIcon className="h-4 w-4 text-gray-500" />
                          <span className="font-medium">{resource.label}</span>
                        </div>
                      </td>
                      <td className="text-center py-3 px-3">
                        {crud.canView ? (
                          <CheckCircle className="h-5 w-5 text-green-600 mx-auto" />
                        ) : (
                          <XCircle className="h-5 w-5 text-red-600 mx-auto" />
                        )}
                        {crud.canCreate ? (
                        {crud.canEdit ? (
                        {crud.canDelete ? (
                    </tr>
                  )
                })}
              </tbody>
            </table>
      {/* UI Component Tests */}
          <CardTitle>UI Component Permission Tests</CardTitle>
            Test permission-based UI component rendering
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            {/* Users Management */}
            <div className="border rounded-lg p-4">
              <h3 className="font-medium mb-3 flex items-center gap-2">
                <Users className="h-4 w-4" />
                Users
              </h3>
              <div className="space-y-2">
                <CRUDGuard resource="users" operation="view">
                  <button className="w-full text-left text-sm px-2 py-1 rounded bg-green-100 text-green-800 flex items-center gap-1">
                    <Eye className="h-3 w-3" />
                    View Users
                  </button>
                </CRUDGuard>
                
                <CRUDGuard resource="users" operation="create">
                  <button className="w-full text-left text-sm px-2 py-1 rounded bg-blue-100 text-blue-800 flex items-center gap-1">
                    <Plus className="h-3 w-3" />
                    Create User
                <CRUDGuard resource="users" operation="edit">
                  <button className="w-full text-left text-sm px-2 py-1 rounded bg-yellow-100 text-yellow-800 flex items-center gap-1">
                    <Edit className="h-3 w-3" />
                    Edit User
                <CRUDGuard resource="users" operation="delete">
                  <button className="w-full text-left text-sm px-2 py-1 rounded bg-red-100 text-red-800 flex items-center gap-1">
                    <Trash2 className="h-3 w-3" />
                    Delete User
              </div>
            {/* Events Management */}
                <Calendar className="h-4 w-4" />
                Events
                <CRUDGuard resource="events" operation="view">
                    View Events
                <CRUDGuard resource="events" operation="create">
                    Create Event
                <CRUDGuard resource="events" operation="edit">
                    Edit Event
                <CRUDGuard resource="events" operation="delete">
                    Delete Event
            {/* Analytics */}
                <BarChart3 className="h-4 w-4" />
                Analytics
                <PermissionGuard permission="analytics.view">
                    View Analytics
                </PermissionGuard>
                <PermissionGuard permission="analytics.export">
                    Export Reports
            {/* System Settings */}
                <Settings className="h-4 w-4" />
                System
                <PermissionGuard permission="system.settings">
                    <Settings className="h-3 w-3" />
                    System Settings
                <PermissionGuard permission="system.backup">
                    Backup System
      {/* API Endpoint Tests */}
          <CardTitle className="flex items-center justify-between">
            API Endpoint Permission Tests
            <button
              onClick={() => {
                apiEndpoints.forEach(endpoint => {
                  testAPIEndpoint(endpoint.url)
                })
              }}
              className="px-3 py-1 text-sm bg-indigo-600 text-white rounded hover:bg-indigo-700"
            >
              Test All APIs
            </button>
          </CardTitle>
            Test API endpoint access based on permissions
          <div className="space-y-3">
            {apiEndpoints.map(endpoint => {
              const result = apiTestResults[endpoint.url]
              const hasRequiredPermission = hasPermission(endpoint.permission)
              
              return (
                <div key={endpoint.url} className="border rounded-lg p-3">
                  <div className="flex items-center justify-between">
                    <div>
                      <div className="font-medium text-sm">{endpoint.label}</div>
                      <div className="text-xs text-gray-500">
                        {endpoint.url} - Requires: {endpoint.permission}
                      </div>
                    </div>
                    
                    <div className="flex items-center gap-2">
                      <span className={`text-xs px-2 py-1 rounded ${
                        hasRequiredPermission 
                          ? 'bg-green-100 text-green-800' 
                          : 'bg-red-100 text-red-800'
                      }`}>
                        {hasRequiredPermission ? 'Allowed' : 'Denied'}
                      </span>
                      
                      <button
                        onClick={() => testAPIEndpoint(endpoint.url)}
                        className="px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded hover:bg-gray-200"
                      >
                        Test
                      </button>
                  </div>
                  {result && (
                    <div className={`mt-2 p-2 rounded text-xs ${
                      result.success 
                        ? 'bg-green-50 text-green-800' 
                        : 'bg-red-50 text-red-800'
                    }`}>
                      <div className="flex items-center justify-between">
                        <span>Status: {result.status}</span>
                        <span>{result.success ? '✅' : '❌'}</span>
                      <div className="mt-1">{result.message}</div>
                  )}
                </div>
              )
            })}
    </div>
  )
